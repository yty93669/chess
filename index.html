<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä¸‰å­æ£‹ - ä¸‰å­å…±çº¿</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: linear-gradient(to bottom right, #f2f2f2, #a1c4fd);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 30px;
    }

    h1 {
      margin-bottom: 10px;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 5px;
      background-color: #444;
      padding: 5px;
      border-radius: 10px;
    }

    .cell {
      width: 100px;
      height: 100px;
      font-size: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #fff;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .cell:hover {
      background-color: #f0f0f0;
    }

    #status, #stepCount {
      margin-top: 15px;
      font-size: 18px;
    }

    button {
      margin: 10px 8px;
      padding: 8px 16px;
      font-size: 15px;
      border: none;
      border-radius: 6px;
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    #historyContainer {
      margin-top: 20px;
      width: 300px;
    }

    #historyList {
      margin-top: 10px;
      max-height: 150px;
      overflow-y: auto;
      padding: 10px;
      background: #fff;
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      text-align: left;
      display: none;
    }
  </style>
</head>
<body>

  <h1>ä¸‰å­æ£‹ï¼ˆæœ€å¤šä¸‰å­ï¼‰</h1>
  <div id="board"></div>

  <div id="status">å½“å‰ç©å®¶ï¼šX</div>
  <div id="stepCount">æ€»æ­¥æ•°ï¼š0</div>

  <div>
    <button onclick="undoMove()">æ‚”æ£‹</button>
    <button onclick="resetGame()">é‡æ–°å¼€å§‹</button>
    <button onclick="toggleHistory()">æ˜¾ç¤º/éšè—å¯¹å±€å†å²</button>
  </div>

  <div id="historyContainer">
    <div id="historyList">æš‚æ— è®°å½•</div>
  </div>

  <script>
    const board = document.getElementById("board");
    const status = document.getElementById("status");
    const stepCountEl = document.getElementById("stepCount");
    const historyList = document.getElementById("historyList");

    let currentPlayer = "X";
    let cells = Array(9).fill(null);
    let moveHistory = { "X": [], "O": [] };
    let fullHistory = [];
    let gameOver = false;
    let stepCount = 0;

    function createBoard() {
      board.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.index = i;
        cell.addEventListener("click", () => handleClick(i));
        board.appendChild(cell);
      }
    }

    function handleClick(index) {
      if (gameOver || cells[index]) return;

      placeMove(index, currentPlayer);
    }

    function placeMove(index, player) {
      if (cells[index]) return;

      // æœ€å¤šä¸‰ä¸ªæ£‹å­ï¼šç§»é™¤æœ€æ—©çš„
      if (moveHistory[player].length === 3) {
        const oldest = moveHistory[player].shift();
        cells[oldest] = null;
        updateCell(oldest, "");
        const idx = fullHistory.findIndex(m => m.player === player && m.index === oldest);
        if (idx !== -1) fullHistory.splice(idx, 1);
      }

      cells[index] = player;
      moveHistory[player].push(index);
      fullHistory.push({ player, index });
      updateCell(index, player);
      stepCount++;
      updateStepAndHistory();

      if (checkWinner(player)) {
        status.textContent = `ğŸ‰ ç©å®¶ ${player} è·èƒœï¼`;
        gameOver = true;
        return;
      }

      currentPlayer = player === "X" ? "O" : "X";
      status.textContent = `å½“å‰ç©å®¶ï¼š${currentPlayer}`;
    }

    function updateCell(index, value) {
      board.children[index].textContent = value;
    }

    function updateStepAndHistory() {
      stepCountEl.textContent = `æ€»æ­¥æ•°ï¼š${stepCount}`;
      historyList.innerHTML = fullHistory.map((move, i) =>
        `ç¬¬ ${i + 1} æ­¥ï¼šç©å®¶ ${move.player} ä¸‹åœ¨æ ¼å­ ${move.index + 1}`
      ).join("<br>") || "æš‚æ— è®°å½•";
    }

    function checkWinner(player) {
      const wins = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
      ];
      const moves = moveHistory[player];
      return wins.some(line => line.every(i => moves.includes(i)));
    }

    function undoMove() {
      if (fullHistory.length === 0) return;
      const last = fullHistory.pop();
      const { player, index } = last;
      cells[index] = null;
      const arr = moveHistory[player];
      arr.splice(arr.lastIndexOf(index), 1);
      updateCell(index, "");
      currentPlayer = player;
      gameOver = false;
      stepCount--;
      updateStepAndHistory();
      status.textContent = `å½“å‰ç©å®¶ï¼š${currentPlayer}`;
    }

    function resetGame() {
      cells = Array(9).fill(null);
      moveHistory = { "X": [], "O": [] };
      fullHistory = [];
      stepCount = 0;
      currentPlayer = "X";
      gameOver = false;
      status.textContent = `å½“å‰ç©å®¶ï¼šX`;
      updateStepAndHistory();
      createBoard();
    }

    function toggleHistory() {
      historyList.style.display = historyList.style.display === "none" ? "block" : "none";
    }

    createBoard();
  </script>

</body>
</html>
